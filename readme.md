# Scripts for withdrawal credential rotation ceremony

## Install

Step 1. Install deps

```bash
yarn
```

Step 2. Create `.env` file from th template

```bash
cp sample.env .env
```

Step 3. Fill out the `.env` file

## Env variables

Some scripts may require some of the following environment variables to be set:

- `EXECUTION_LAYER` – RPC URL of execution layer client
- `CONSENSUS_LAYER` – API URL of consensus layer client
- `PRIVATE_KEY` – `0x` prefixed private key of account with some eth to send transactions

## Scripts

### Public key to withdrawal credentials

The script converts a public key into a withdrawal credentials 0x00 type. It takes the `sha256` from the public key and replaces the first byte to 0.

```bash
yarn convert_pubkey_to_wc tnrKcfBLZzA3tUAJt2Dxlh84NuVxQUHIkq/bdewINNzmeE2ccu2K19syjP+P6fE+
```

Arguments:

- public key in base64 or hex format to convert to withdrawal credentials

### Send deposit tx

The script sends deposit transactions to the deposit contract from deposit data file generated by [staking deposit cli](https://github.com/ethereum/staking-deposit-cli).

```bash
yarn send_deposit_txs -d deposit_data.json
```

Options:

- `-d`, `--deposit-data-path` – path to deposit data file

The script requires env variables to be set:

- `EXECUTION_LAYER`
- `CONSENSUS_LAYER`
- `PRIVATE_KEY`

### Fetch validators indexes by withdrawal credentials

The script fetches data about validators from Consensus Layer and Execution Layer which matches to the passed withdrawal credentials and generates a CSV file with validator indexes. This file can later be used in [dc4bc](https://github.com/lidofinance/dc4bc/) to sign messages to rotate withdrawal credentials from type `0x00` to `0x01`.

The data is fetched from the deposit contract on Execution Layer and the form the finalized state on Consensus Layer to reduce the risk of incorrect data.

```bash
yarn fetch_validators_by_wc -w 0x009690e5d4472c7c0dbdf490425d89862535d2a52fb686333f3a0a9ff5d2125e output.csv
```

Options:

- `-w`, `--withdrawal-credentials` – withdrawal_credentials by which validators will be filtered
- `-s`, `--fetch-step` – step with which events from deposit contract are requested. Reduce this value if there are problems with fetching data (100,000 by default)

Arguments:

- file path for the output file

The script requires env variables to be set:

- `EXECUTION_LAYER`
- `CONSENSUS_LAYER`

### Validate file with validators indexes

The script validates data from the validator indexes file:

- Checks gaps in message indexes and their order
- Checks that all the validator indexes correspond to the validators on the Consensus Layer with the passed withdrawal credentials

```bash
yarn validate_validators_indexes -w 0x009690e5d4472c7c0dbdf490425d89862535d2a52fb686333f3a0a9ff5d2125e output.csv
```

Options:

- `-w`, `--withdrawal-credentials` – withdrawal_credentials by which validators will be filtered

Arguments:

- file path for the input file

The script requires env variables to be set:

- `CONSENSUS_LAYER`
